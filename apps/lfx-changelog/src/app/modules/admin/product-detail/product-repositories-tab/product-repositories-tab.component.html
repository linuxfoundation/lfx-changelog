<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->

<div class="space-y-4">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <p class="text-text-secondary text-sm">Manage GitHub repositories linked to this product for changelog generation.</p>
    <div class="flex gap-2">
      <lfx-button variant="secondary" (clicked)="installOnNewOrg()">
        <i class="fa-brands fa-github text-sm"></i>
        Install on New Org
      </lfx-button>
      <lfx-button variant="primary" (clicked)="openAddDialog()">
        <i class="fa-solid fa-plus text-xs"></i>
        Add Repository
      </lfx-button>
    </div>
  </div>

  @if (loading()) {
    <div class="flex items-center justify-center py-12">
      <i class="fa-duotone fa-spinner-third text-brand-600 animate-spin text-2xl"></i>
    </div>
  } @else if (linkedRepos().length === 0) {
    <lfx-card>
      <div class="flex flex-col items-center justify-center py-12 text-center">
        <i class="fa-duotone fa-code-branch text-text-muted mb-3 text-4xl"></i>
        <h3 class="text-text-primary mb-1 text-base font-medium">No repositories linked</h3>
        <p class="text-text-muted max-w-sm text-sm">Link GitHub repositories to this product to automatically generate changelogs from commits and releases.</p>
      </div>
    </lfx-card>
  } @else {
    <lfx-table [data]="linkedRepos()">
      <ng-template lfxColumn="Repository" let-repo>
        <a [href]="repo.htmlUrl" target="_blank" rel="noopener noreferrer" class="text-brand-600 hover:text-brand-700 text-sm font-medium hover:underline">
          {{ repo.name }}
        </a>
        @if (repo.description) {
          <p class="text-text-muted mt-0.5 max-w-xs truncate text-xs">{{ repo.description }}</p>
        }
      </ng-template>

      <ng-template lfxColumn="Owner" let-repo>
        <span class="text-text-secondary text-sm">{{ repo.owner }}</span>
      </ng-template>

      <ng-template lfxColumn="Visibility" let-repo>
        @if (repo.isPrivate) {
          <span class="rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800 dark:bg-amber-900/30 dark:text-amber-400">Private</span>
        } @else {
          <span class="rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800 dark:bg-green-900/30 dark:text-green-400">Public</span>
        }
      </ng-template>

      <ng-template lfxColumn="Actions" let-repo>
        <lfx-button variant="ghost" size="sm" (clicked)="unlinkRepository(repo)">
          <i class="fa-solid fa-unlink text-xs"></i>
          Unlink
        </lfx-button>
      </ng-template>
    </lfx-table>
  }
</div>

<!-- Add Repository Dialog -->
<lfx-dialog [(visible)]="dialogVisible" [title]="dialogTitle()" size="lg">
  @switch (dialogStep()) {
    @case ('select-installation') {
      <div class="space-y-4">
        @if (loadingInstallations()) {
          <div class="flex items-center justify-center py-8">
            <i class="fa-duotone fa-spinner-third text-brand-600 animate-spin text-xl"></i>
          </div>
        } @else if (installationOptions().length === 0) {
          <div class="py-6 text-center">
            <p class="text-text-muted mb-3 text-sm">No GitHub App installations found.</p>
            <lfx-button variant="secondary" (clicked)="installOnNewOrg()">
              <i class="fa-brands fa-github text-sm"></i>
              Install GitHub App
            </lfx-button>
          </div>
        } @else {
          <p class="text-text-secondary text-sm">Choose the GitHub organization to browse repositories from.</p>
          <lfx-select label="Organization" [options]="installationOptions()" placeholder="Select an organization..." [formControl]="installationControl" />
          <div class="flex justify-end gap-3 pt-2">
            <lfx-button variant="secondary" (clicked)="dialogVisible.set(false)">Cancel</lfx-button>
            <lfx-button variant="primary" [disabled]="!installationControl.value" (clicked)="goToSelectRepos()">Next</lfx-button>
          </div>
        }
      </div>
    }
    @case ('select-repos') {
      <div class="space-y-4">
        @if (loadingRepos()) {
          <div class="flex items-center justify-center py-8">
            <i class="fa-duotone fa-spinner-third text-brand-600 animate-spin text-xl"></i>
          </div>
        } @else if (availableRepos().length === 0) {
          <div class="py-6 text-center">
            <p class="text-text-muted text-sm">No repositories found for this installation.</p>
          </div>
        } @else {
          <p class="text-text-secondary text-sm">Select repositories to link. {{ selectedCount() }} selected.</p>
          <div class="border-border divide-border divide-y overflow-y-auto rounded-lg border" style="max-height: 360px">
            @for (repo of availableRepos(); track repo.full_name) {
              <label class="hover:bg-surface-alt flex cursor-pointer items-center gap-3 px-4 py-3 transition-colors">
                <input
                  type="checkbox"
                  [checked]="repoSelectionMap() | mapGet: repo.full_name"
                  (change)="toggleRepo(repo.full_name)"
                  class="text-brand-600 focus:ring-brand-500 h-4 w-4 rounded border-gray-300" />
                <div class="min-w-0 flex-1">
                  <div class="flex items-center gap-2">
                    <span class="text-text-primary truncate text-sm font-medium">{{ repo.name }}</span>
                    @if (repo.private) {
                      <span
                        class="shrink-0 rounded-full bg-amber-100 px-1.5 py-0.5 text-[10px] font-medium text-amber-800 dark:bg-amber-900/30 dark:text-amber-400"
                        >Private</span
                      >
                    }
                  </div>
                  @if (repo.description) {
                    <p class="text-text-muted mt-0.5 truncate text-xs">{{ repo.description }}</p>
                  }
                </div>
              </label>
            }
          </div>
        }
        <div class="flex justify-end gap-3 pt-2">
          <lfx-button variant="ghost" (clicked)="goBackToInstallations()">Back</lfx-button>
          <lfx-button variant="secondary" (clicked)="dialogVisible.set(false)">Cancel</lfx-button>
          <lfx-button variant="primary" [loading]="saving()" [disabled]="selectedCount() === 0" (clicked)="linkSelected()">
            Link Selected ({{ selectedCount() }})
          </lfx-button>
        </div>
      </div>
    }
  }
</lfx-dialog>
