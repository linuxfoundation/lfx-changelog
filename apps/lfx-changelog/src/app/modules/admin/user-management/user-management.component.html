<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->

<div class="space-y-6">
  <div class="animate-slide-in-left flex items-center justify-between">
    <div>
      <h1 data-testid="user-management-heading" class="font-display text-text-primary text-2xl font-bold">Users</h1>
      <p class="text-text-secondary mt-1">Manage user access and role assignments.</p>
    </div>
    <lfx-button data-testid="user-management-add-user-btn" variant="primary" (clicked)="openAddUserDialog()">
      <i class="fa-solid fa-plus text-xs"></i>
      Add User
    </lfx-button>
  </div>

  <lfx-table class="animate-rise-in block [animation-delay:150ms]" [data]="users()" [loading]="loading()" testId="user-management-table">
    <ng-template lfxColumn="User" let-user>
      <div class="flex items-center gap-3">
        <lfx-avatar [src]="user.avatarUrl" [name]="user.name" size="sm" />
        <span class="text-text-primary text-sm font-medium">{{ user.name }}</span>
      </div>
    </ng-template>

    <ng-template lfxColumn="Email" let-user>
      <span class="text-text-secondary text-sm">{{ user.email }}</span>
    </ng-template>

    <ng-template lfxColumn="Roles" let-user>
      <div class="flex flex-wrap gap-1">
        @for (ra of user.roles; track ra.id) {
          <div class="flex items-center gap-1">
            <lfx-badge [label]="ra.role | roleLabel" [color]="ra.role | roleColor" size="sm" />
            @if (ra.productId) {
              <span class="text-text-muted text-xs">({{ ra.productId | productName: products() }})</span>
            }
          </div>
        }
      </div>
    </ng-template>

    <ng-template lfxColumn="Actions" let-user>
      <lfx-button [attr.data-testid]="'user-management-manage-roles-' + user.id" variant="ghost" size="sm" (clicked)="openRoleDialog(user)"
        >Manage Roles</lfx-button
      >
    </ng-template>
  </lfx-table>
</div>

<lfx-dialog data-testid="user-role-dialog" [(visible)]="dialogVisible" title="Manage Roles">
  @if (selectedUser(); as user) {
    <div data-testid="user-role-dialog-content" class="space-y-5">
      <div>
        <h3 data-testid="user-role-dialog-name" class="text-text-primary text-sm font-medium">{{ user.name }}</h3>
        <p data-testid="user-role-dialog-email" class="text-text-muted text-xs">{{ user.email }}</p>
      </div>

      <div>
        <h4 class="text-text-muted mb-2 text-xs font-medium tracking-wider uppercase">Current Roles</h4>
        <div data-testid="user-role-dialog-current-roles" class="space-y-2">
          @for (ra of user.roles; track ra.id) {
            <div data-testid="user-role-dialog-role-item" class="border-border bg-surface-alt flex items-center justify-between rounded-lg border px-3 py-2">
              <div class="flex items-center gap-2">
                <lfx-badge [label]="ra.role | roleLabel" [color]="ra.role | roleColor" size="sm" />
                <span class="text-text-secondary text-sm">{{ ra.productId | productName: products() }}</span>
              </div>
              <lfx-button data-testid="user-role-dialog-remove-btn" variant="ghost" size="sm" (clicked)="removeRole(user, ra.id)">Remove</lfx-button>
            </div>
          }
        </div>
      </div>

      <div class="border-border border-t pt-4">
        <h4 class="text-text-muted mb-3 text-xs font-medium tracking-wider uppercase">Assign New Role</h4>
        <lfx-select
          data-testid="user-role-dialog-role-select"
          label="Role"
          [options]="roleOptions"
          [formControl]="newRoleControl"
          placeholder="Select role..." />
        @if (!newRoleIsSuperAdmin()) {
          <lfx-select
            data-testid="user-role-dialog-product-select"
            label="Product"
            [options]="productOptions()"
            [formControl]="newProductControl"
            placeholder="Select product..."
            class="mt-3 block" />
        }
        <div class="mt-3 flex justify-end">
          <lfx-button data-testid="user-role-dialog-assign-btn" variant="primary" size="sm" (clicked)="assignRole()">Assign Role</lfx-button>
        </div>
      </div>
    </div>
  }
</lfx-dialog>

<lfx-dialog data-testid="add-user-dialog" [(visible)]="addUserDialogVisible" title="Add User">
  <div class="space-y-4">
    @if (addUserError(); as errorMsg) {
      <div
        data-testid="add-user-error"
        class="rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700 dark:border-red-800 dark:bg-red-950 dark:text-red-300">
        {{ errorMsg }}
      </div>
    }
    <lfx-input data-testid="add-user-email-input" label="Email" [formControl]="addUserEmailControl" placeholder="user@example.com" type="email" />
    <lfx-input data-testid="add-user-name-input" label="Name" [formControl]="addUserNameControl" placeholder="Full name" />
    <lfx-select
      data-testid="add-user-role-select"
      label="Role"
      [options]="addUserRoleOptions"
      [formControl]="addUserRoleControl"
      placeholder="Select role..." />
    @if (!addUserIsSuperAdmin()) {
      <lfx-select
        data-testid="add-user-product-select"
        label="Product"
        [options]="productOptions()"
        [formControl]="addUserProductControl"
        placeholder="Select product..." />
    }
    <div class="flex justify-end gap-2 pt-2">
      <lfx-button variant="secondary" size="sm" (clicked)="addUserDialogVisible.set(false)">Cancel</lfx-button>
      <lfx-button data-testid="add-user-create-btn" variant="primary" size="sm" (clicked)="createUser()">Create User</lfx-button>
    </div>
  </div>
</lfx-dialog>
