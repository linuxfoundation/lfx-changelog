generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ChangelogStatus {
  draft
  published
}

enum UserRole {
  super_admin
  product_admin
  editor
}

enum ApiKeyScope {
  changelogs_read
  changelogs_write
  products_read
  products_write
}

enum ChatAccessLevel {
  public
  admin
}

model Product {
  id                    String   @id @default(uuid())
  name                  String   @unique
  slug                  String   @unique
  description           String?
  iconUrl               String?  @map("icon_url")
  faIcon                String?  @map("fa_icon")
  isActive              Boolean  @default(true) @map("is_active")
  githubInstallationId  Int?     @map("github_installation_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  changelogEntries    ChangelogEntry[]
  userRoleAssignments UserRoleAssignment[]
  repositories        ProductRepository[]

  @@map("products")
}

model ProductRepository {
  id                    String   @id @default(uuid())
  productId             String   @map("product_id")
  githubInstallationId  Int      @map("github_installation_id")
  owner                 String
  name                  String
  fullName              String   @map("full_name")
  htmlUrl               String   @map("html_url")
  description           String?
  isPrivate             Boolean  @default(false) @map("is_private")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, owner, name])
  @@index([productId])
  @@map("product_repositories")
}

model ChangelogEntry {
  id          String            @id @default(uuid())
  productId   String            @map("product_id")
  title       String
  description String
  version     String?
  status      ChangelogStatus   @default(draft)
  publishedAt DateTime?         @map("published_at")
  createdBy   String            @map("created_by")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id])
  author  User    @relation(fields: [createdBy], references: [id])

  @@index([productId, status, publishedAt])
  @@map("changelog_entries")
}

model User {
  id        String   @id @default(uuid())
  auth0Id   String?  @unique @map("auth0_id")
  email     String   @unique
  name      String
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  changelogEntries    ChangelogEntry[]
  userRoleAssignments UserRoleAssignment[]
  apiKeys             ApiKey[]
  chatConversations   ChatConversation[]

  @@map("users")
}

model UserRoleAssignment {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String?  @map("product_id")
  role      UserRole
  createdAt DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id])
  product Product? @relation(fields: [productId], references: [id])

  @@unique([userId, productId, role])
  @@index([userId, productId])
  @@map("user_role_assignments")
}

model ApiKey {
  id         String        @id @default(uuid())
  userId     String        @map("user_id")
  name       String
  keyPrefix  String        @map("key_prefix")
  keyHash    String        @unique @map("key_hash")
  scopes     ApiKeyScope[] @default([])
  expiresAt  DateTime      @map("expires_at")
  lastUsedAt DateTime?     @map("last_used_at")
  revokedAt  DateTime?     @map("revoked_at")
  createdAt  DateTime      @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
  @@map("api_keys")
}

model ChatConversation {
  id          String          @id @default(uuid())
  userId      String?         @map("user_id")
  title       String          @default("New conversation")
  accessLevel ChatAccessLevel @default(public) @map("access_level")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  user     User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages ChatMessage[]

  @@index([userId])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           String
  content        String?
  toolCalls      Json?    @map("tool_calls")
  toolCallId     String?  @map("tool_call_id")
  toolName       String?  @map("tool_name")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("chat_messages")
}
