---
# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT

name: Deploy Changelog Development

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  STAGE: dev
  AWS_REGION: us-east-2
  REPOSITORY: lfx-changelog-ecr
  ECR_HOST: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-2.amazonaws.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    name: Build & Deploy LFX Changelog
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy
          aws-region: us-east-2

      - name: Build Docker Image
        run: |
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_HOST}
          docker buildx build --load --tag ${ECR_HOST}/${REPOSITORY}:${{ github.sha }} --build-arg BUILD_ENV=${STAGE} -f Dockerfile .

      - name: Push Docker Image
        run: |
          docker push ${ECR_HOST}/${REPOSITORY}:${{ github.sha }}

      - name: Register ECS Task Definition
        run: >
          aws ecs register-task-definition --family lfx-changelog-service
          --task-role-arn arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/lfx-changelog-serviceTaskExecutionRole
          --network-mode awsvpc
          --cpu 1024
          --memory 2048
          --requires-compatibilities FARGATE
          --execution-role-arn arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/lfx-changelog-serviceTaskExecutionRole
          --container-definitions '[
            {
              "name": "lfx-changelog-service",
              "image": "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-2.amazonaws.com/lfx-changelog-ecr:${{ github.sha }}",
              "portMappings": [
                {
                  "containerPort": 4000,
                  "hostPort": 4000,
                  "protocol": "tcp"
                }
              ],
              "secrets": [
                {
                  "name": "AUTH0_SECRET",
                  "valueFrom": "arn:aws:secretsmanager:us-east-2:${{ secrets.AWS_ACCOUNT_ID }}:secret:/cloudops/managed-secrets/cloud/pcc-changelog/custom_cookie_sig_secret"
                },
                {
                  "name": "AUTH0_CLIENT_SECRET",
                  "valueFrom": "arn:aws:secretsmanager:us-east-2:${{ secrets.AWS_ACCOUNT_ID }}:secret:/cloudops/managed-secrets/auth0/LFX_Changelog:client_secret::"
                },
                {
                  "name": "AUTH0_CLIENT_ID",
                  "valueFrom": "arn:aws:secretsmanager:us-east-2:${{ secrets.AWS_ACCOUNT_ID }}:secret:/cloudops/managed-secrets/auth0/LFX_Changelog:client_id::"
                },
                {
                  "name": "DB_PASSWORD",
                  "valueFrom": "arn:aws:secretsmanager:us-east-2:${{ secrets.AWS_ACCOUNT_ID }}:secret:/cloudops/managed-secrets/database/pcc-db/changelog"
                }
              ],
              "environment": [
                { "name": "NODE_ENV", "value": "production" },
                { "name": "PORT", "value": "4000" },
                { "name": "BASE_URL", "value": "https://changelog.dev.platform.linuxfoundation.org" },
                { "name": "AUTH0_ISSUER_BASE_URL", "value": "https://linuxfoundation-dev.auth0.com" },
                { "name": "AUTH0_AUDIENCE", "value": "https://api-gw.dev.platform.linuxfoundation.org/" },
                { "name": "DB_HOST", "value": "dev-changelog-database.cs2y6rcs4jow.us-east-2.rds.amazonaws.com" },
                { "name": "DB_PORT", "value": "5432" },
                { "name": "DB_NAME", "value": "lfx_changelog" },
                { "name": "DB_USER", "value": "changelog" }
              ],
              "essential": true,
              "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                  "awslogs-group": "/ecs/lfx-pcc-bff-lfx-changelog-service-logs",
                  "awslogs-region": "us-east-2",
                  "awslogs-stream-prefix": "lfx-changelog-service"
                }
              }
            }
          ]'

      - name: Deploy to ECS
        run: |
          aws ecs update-service --force-new-deployment --cluster lfx-pcc-bff --service lfx-changelog-service --task-definition lfx-changelog-service
