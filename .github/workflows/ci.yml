---
# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT

name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  license-headers:
    runs-on: ubuntu-latest
    name: Check License Headers
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check license headers
        run: ./check-headers.sh

  secret-scan:
    runs-on: ubuntu-latest
    name: Secret Scan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Trufflehog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan with Trufflehog
        env:
          SINCE_COMMIT: ${{ github.event.before || github.event.pull_request.base.sha }}
        run: |
          trufflehog git file://. --fail --no-update --only-verified --since-commit="$SINCE_COMMIT"

  e2e:
    runs-on: ubuntu-latest
    name: E2E Tests
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy
          aws-region: us-west-2

      - name: Read secrets from AWS Secrets Manager into environment variables
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            AUTH0, /cloudops/managed-secrets/auth0/LFX_Changelog
            AUTH0_COOKIE_SECRET, /cloudops/managed-secrets/cloud/changelog/auth0_secret

      - name: Set up non-sensitive environment variables
        run: |
          echo "DB_HOST=localhost" >> "$GITHUB_ENV"
          echo "DB_PORT=5433" >> "$GITHUB_ENV"
          echo "DB_NAME=lfx_changelog_test" >> "$GITHUB_ENV"
          echo "DB_USER=changelog" >> "$GITHUB_ENV"
          echo "DB_PASSWORD=changelog_dev" >> "$GITHUB_ENV"
          echo "AUTH0_ISSUER_BASE_URL=https://linuxfoundation-dev.auth0.com" >> "$GITHUB_ENV"
          echo "BASE_URL=http://localhost:4204" >> "$GITHUB_ENV"
          echo "SKIP_RATE_LIMIT=true" >> "$GITHUB_ENV"
          echo "CI=true" >> "$GITHUB_ENV"

      - name: Generate Prisma client
        run: yarn workspace lfx-changelog prisma generate

      - name: Set up sensitive environment variables
        env:
          E2E_SUPER_ADMIN_USERNAME: ${{ secrets.E2E_SUPER_ADMIN_USERNAME }}
          E2E_SUPER_ADMIN_PASSWORD: ${{ secrets.E2E_SUPER_ADMIN_PASSWORD }}
          E2E_PRODUCT_ADMIN_USERNAME: ${{ secrets.E2E_PRODUCT_ADMIN_USERNAME }}
          E2E_PRODUCT_ADMIN_PASSWORD: ${{ secrets.E2E_PRODUCT_ADMIN_PASSWORD }}
          E2E_EDITOR_USERNAME: ${{ secrets.E2E_EDITOR_USERNAME }}
          E2E_EDITOR_PASSWORD: ${{ secrets.E2E_EDITOR_PASSWORD }}
          E2E_USER_USERNAME: ${{ secrets.E2E_USER_USERNAME }}
          E2E_USER_PASSWORD: ${{ secrets.E2E_USER_PASSWORD }}
          E2E_SUPER_ADMIN_EMAIL: ${{ secrets.E2E_SUPER_ADMIN_EMAIL }}
          E2E_PRODUCT_ADMIN_EMAIL: ${{ secrets.E2E_PRODUCT_ADMIN_EMAIL }}
          E2E_EDITOR_EMAIL: ${{ secrets.E2E_EDITOR_EMAIL }}
          E2E_USER_EMAIL: ${{ secrets.E2E_USER_EMAIL }}
        run: |
          # Parse Auth0 app credentials from JSON secret
          AUTH0_CLIENT_ID=$(echo "$AUTH0" | jq -r '.client_id')
          AUTH0_CLIENT_SECRET=$(echo "$AUTH0" | jq -r '.client_secret')

          if [ -z "$AUTH0_CLIENT_ID" ] || [ "$AUTH0_CLIENT_ID" = "null" ]; then
            echo "::error::Failed to parse AUTH0_CLIENT_ID from AWS secret"
            exit 1
          fi
          if [ -z "$AUTH0_CLIENT_SECRET" ] || [ "$AUTH0_CLIENT_SECRET" = "null" ]; then
            echo "::error::Failed to parse AUTH0_CLIENT_SECRET from AWS secret"
            exit 1
          fi

          # Parse Auth0 session secret from JSON secret
          AUTH0_SECRET_VALUE=$(echo "$AUTH0_COOKIE_SECRET" | jq -r '.auth_secret')

          if [ -z "$AUTH0_SECRET_VALUE" ] || [ "$AUTH0_SECRET_VALUE" = "null" ]; then
            echo "::error::Failed to parse auth_secret from AWS secret"
            exit 1
          fi

          echo "::add-mask::$AUTH0_CLIENT_ID"
          echo "::add-mask::$AUTH0_CLIENT_SECRET"
          echo "::add-mask::$AUTH0_SECRET_VALUE"

          echo "AUTH0_CLIENT_ID=$AUTH0_CLIENT_ID" >> "$GITHUB_ENV"
          echo "AUTH0_CLIENT_SECRET=$AUTH0_CLIENT_SECRET" >> "$GITHUB_ENV"
          echo "AUTH0_SECRET=$AUTH0_SECRET_VALUE" >> "$GITHUB_ENV"

          # Set test user credentials
          echo "::add-mask::$E2E_SUPER_ADMIN_USERNAME"
          echo "::add-mask::$E2E_SUPER_ADMIN_PASSWORD"
          echo "::add-mask::$E2E_PRODUCT_ADMIN_USERNAME"
          echo "::add-mask::$E2E_PRODUCT_ADMIN_PASSWORD"
          echo "::add-mask::$E2E_EDITOR_USERNAME"
          echo "::add-mask::$E2E_EDITOR_PASSWORD"
          echo "::add-mask::$E2E_USER_USERNAME"
          echo "::add-mask::$E2E_USER_PASSWORD"
          echo "::add-mask::$E2E_SUPER_ADMIN_EMAIL"
          echo "::add-mask::$E2E_PRODUCT_ADMIN_EMAIL"
          echo "::add-mask::$E2E_EDITOR_EMAIL"
          echo "::add-mask::$E2E_USER_EMAIL"

          echo "E2E_SUPER_ADMIN_USERNAME=$E2E_SUPER_ADMIN_USERNAME" >> "$GITHUB_ENV"
          echo "E2E_SUPER_ADMIN_PASSWORD=$E2E_SUPER_ADMIN_PASSWORD" >> "$GITHUB_ENV"
          echo "E2E_PRODUCT_ADMIN_USERNAME=$E2E_PRODUCT_ADMIN_USERNAME" >> "$GITHUB_ENV"
          echo "E2E_PRODUCT_ADMIN_PASSWORD=$E2E_PRODUCT_ADMIN_PASSWORD" >> "$GITHUB_ENV"
          echo "E2E_EDITOR_USERNAME=$E2E_EDITOR_USERNAME" >> "$GITHUB_ENV"
          echo "E2E_EDITOR_PASSWORD=$E2E_EDITOR_PASSWORD" >> "$GITHUB_ENV"
          echo "E2E_USER_USERNAME=$E2E_USER_USERNAME" >> "$GITHUB_ENV"
          echo "E2E_USER_PASSWORD=$E2E_USER_PASSWORD" >> "$GITHUB_ENV"
          echo "E2E_SUPER_ADMIN_EMAIL=$E2E_SUPER_ADMIN_EMAIL" >> "$GITHUB_ENV"
          echo "E2E_PRODUCT_ADMIN_EMAIL=$E2E_PRODUCT_ADMIN_EMAIL" >> "$GITHUB_ENV"
          echo "E2E_EDITOR_EMAIL=$E2E_EDITOR_EMAIL" >> "$GITHUB_ENV"
          echo "E2E_USER_EMAIL=$E2E_USER_EMAIL" >> "$GITHUB_ENV"

      - name: Install Playwright Chromium
        run: npx playwright install chromium --with-deps

      - name: Run Playwright tests
        working-directory: apps/lfx-changelog
        run: yarn playwright test

      - name: Stop test database
        if: ${{ !cancelled() }}
        run: docker compose down postgres-test
