# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT

apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "lfx-changelog.fullname" . }}-migrate-{{ .Release.Revision }}
  labels:
    {{- include "lfx-changelog.labels" . | nindent 4 }}
  annotations:
    # Run before both first install and subsequent upgrades
    "helm.sh/hook": pre-install,pre-upgrade
    # Run before other hooks (lower weight = first)
    "helm.sh/hook-weight": "-1"
    # Delete previous migration Job before creating a new one
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  # Retry up to 3 times on failure (e.g. transient DB connectivity)
  backoffLimit: 3
  # Hard timeout â€” if migrations haven't finished in 2 minutes, abort
  activeDeadlineSeconds: 120
  template:
    metadata:
      labels:
        {{- include "lfx-changelog.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ .Values.serviceAccount.name | default (include "lfx-changelog.serviceAccountName" .) }}
      restartPolicy: Never
      containers:
        - name: migrate
          image: {{ include "lfx-changelog.image" . }}
          command: ["npx"]
          args: ["prisma", "migrate", "deploy"]
          env:
          {{- range $name, $config := .Values.environment }}
          - name: {{ $name }}
            {{- if $config.value }}
            value: {{ $config.value | quote }}
            {{- else if $config.valueFrom }}
            valueFrom:
              {{- toYaml $config.valueFrom | nindent 14 }}
            {{- end }}
          {{- end }}
          resources:
            limits:
              cpu: 250m
              memory: 256Mi
            requests:
              cpu: 100m
              memory: 128Mi
